{% assign emptyarray = "" | split: "," %}
{% assign data = site.data[include.data]
  | default: site[include.data]
  | default: emptyarray
  | data_filter: include.filters
%}

  <!-- Flags (Liquid include params are usually strings)
  - sort: default true. Pass sort="false" to preserve data order.
  - alumni: true/false. Auto-enabled if component == "portraitalumni". -->

{% assign sort_enabled = true %}
{% if include.sort == false or include.sort == "false" %}
  {% assign sort_enabled = false %}
{% endif %}

{% assign is_alumni = false %}
{% if include.alumni == true or include.alumni == "true" %}
  {% assign is_alumni = true %}
{% endif %}
{% if include.component == "portraitalumni" %}
  {% assign is_alumni = true %}
{% endif %}

  <!-- Build `sorted_data` and `groups`
  - Alumni: group by alum_year (and optionally split with_year/without_year)
  - Default: group by date-year -->

{% if is_alumni %}

  <!-- Alumni-specific ordering: with alum_year first, then without alum_year -->
  {% assign with_year = data | where_exp: "item", "item.alum_year" %}
  {% assign without_year = data | where_exp: "item", "item.alum_year == nil" %}

  {% assign with_year = with_year | sort: "alum_year" | reverse %}
  {% assign without_year = without_year | sort: "grade" | reverse %}

  {% assign sorted_data = with_year | concat: without_year %}

  <!-- Group by alum_year; use 0 for missing year so they end up in a "No year" bucket. -->
  {% assign groups = sorted_data | group_by_exp: "d", "d.alum_year | default: 0" %}

  {% assign groups = groups | sort: "name" | reverse %}

{% else %}

  <!-- Default mode (posts/pubs/github/etc.)  -->
  {% assign sorted_data = data %}

  {% if sort_enabled %}
    {% assign sort_key = include.sort_by | default: "date" %}
    {% assign sorted_data = sorted_data | sort: sort_key %}
    {% assign sort_order = include.sort_order | default: "desc" %}
    {% if sort_order == "desc" %}
      {% assign sorted_data = sorted_data | reverse %}
    {% endif %}
  {% endif %}

  {% assign groups = sorted_data
    | group_by_exp: "d", "d.date | date: '%Y'"
  %}

  {% if sort_enabled %}
    {% assign groups = groups | sort: "name" | reverse %}
  {% endif %}

{% endif %}


  <!-- Render groups
  - Show headers only if multiple groups
  - If sort is disabled, do NOT reorder items inside group (keeps YAML order) -->

{% for year in groups %}
  {% assign group_data = year.items %}

  {% if groups.size > 1 %}
    <!-- {% if is_alumni %}
      {% if year.name == "0" %}
        <h3 id="no-year">No year</h3>
      {% else %}
        <h3 id="{{ year.name }}">{{ year.name }}</h3>
      {% endif %}
    {% else %}
      <h3 id="{{ year.name }}">{{ year.name }}</h3>
    {% endif %} -->

    {% if sort_enabled and is_alumni == false %}
      {%- comment -%} Optional per-year sort by date in normal mode {%- endcomment -%}
      {% assign group_data = group_data | sort: "date" | reverse %}
    {% endif %}
  {% endif %}

  {% for d in group_data %}
    {% assign style = d.style | default: include.style %}

    {%
      include {{ include.component | append: ".html" }}
      author=d.author
      authors=d.authors
      buttons=d.buttons
      caption=d.caption
      content=d.content
      date=d.date
      description=d.description
      excerpt=d.excerpt
      height=d.height
      icon=d.icon
      id=d.id
      image=d.image
      last_modified_at=d.last_modified_at
      link=d.link
      lookup=d.lookup
      name=d.name
      publisher=d.publisher
      repo=d.repo
      role=d.role
      slug=d.slug
      style=style
      subtitle=d.subtitle
      tags=d.tags
      text=d.text
      title=d.title
      tooltip=d.tooltip
      type=d.type
      url=d.url
      width=d.width
      alum_year=d.alum_year
      alum_role=d.alum_role
    %}
  {% endfor %}
{% endfor %}
